---
description: Shared code patterns across Helvety apps
globs: ["lib/**/*.ts", "lib/**/*.tsx", "components/**/*.tsx"]
---

# Shared Code Patterns

## Files That Must Stay Synchronized

These files are shared across helvety.com, helvety-auth, helvety-pdf, and helvety-store. When modifying these files, the same changes should be applied to all repos.

### Core Utilities (must be identical)

- `lib/utils.ts` (cn, generateSecureId)
- `lib/logger.ts`
- `lib/constants.ts` – helvety.com, helvety-auth, helvety-store: identical (TOAST_DURATIONS). helvety-pdf: not synced; keeps its own file with TOAST_DURATIONS plus PDF-specific constants (BREAKPOINTS, FILE_LIMITS, etc.).

### Crypto Module (must be identical)

- `lib/crypto/encoding.ts`
- `lib/crypto/encryption.ts`
- `lib/crypto/encryption-context.tsx`
- `lib/crypto/index.ts`
- `lib/crypto/key-storage.ts`
- `lib/crypto/passkey.ts`
- `lib/crypto/prf-key-derivation.ts`
- `lib/crypto/types.ts`

### Auth Utilities (must be identical across repos that use them)

- `lib/auth-errors.ts`
- `lib/auth-logger.ts`
- `lib/auth-redirect.ts`
- `lib/auth-guard.ts` – helvety-auth: not synced (redirects to local `/login`). Other apps: synced (redirects to auth service via `getLoginUrl()`).
- `lib/redirect-validation.ts`
- `lib/rate-limit.ts`
- `lib/csrf.ts`

### Components (must be identical)

- `components/theme-provider.tsx`
- `components/theme-switcher.tsx`
- `components/app-switcher.tsx`

### Infrastructure (must be identical)

- `proxy.ts` (Next.js 16 proxy: session refresh and cookie domain)
- `scripts/generate-version.js`

## App-Specific Code

Put app-specific utilities in appropriately named files:

- **helvety-pdf**: `lib/pdf-*.ts`, `lib/file-*.ts`, `lib/memory-*.ts`
- **helvety-store**: `lib/stripe/*.ts`, `lib/license/*.ts`, `lib/packages/*.ts`
- **helvety-auth**: `lib/auth-utils.ts` (auth-specific, not shared)

## When Adding New Shared Code

1. Add to one repo first
2. Verify the changes work correctly
3. Copy to all other repos
4. Commit changes to all repos together (or sequentially)

## Cursor rules

Shared rule files in `.cursor/rules/` (`code-organization.mdc`, `jsdoc-style.mdc`, `shared-code-patterns.mdc`, `after-change-checklist.mdc`, `official-docs-first.mdc`) should be kept in sync across helvety.com, helvety-auth, helvety-pdf, and helvety-store so all four follow the same standards.
