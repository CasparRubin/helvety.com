---
description: Shared code patterns across Helvety apps
globs: ["lib/**/*.ts", "lib/**/*.tsx", "components/**/*.tsx"]
---

# Shared Code Patterns

## Files That Must Stay Synchronized

These files are shared across helvety.com, helvety-auth, helvety-pdf, helvety-store, and helvety-tasks. When modifying these files, the same changes should be applied to all repos.

### Core Utilities (must be identical)

- `lib/utils.ts` (cn, generateSecureId)
- `lib/logger.ts`
- `lib/constants.ts` – helvety.com, helvety-auth, helvety-store, helvety-tasks: identical (TOAST_DURATIONS). helvety-pdf: not synced; keeps its own file with TOAST_DURATIONS plus PDF-specific constants (BREAKPOINTS, FILE_LIMITS, etc.).

### Crypto Module (must be identical; actively used only by helvety-tasks and helvety-auth)

> **Note:** The crypto module is synced to all repos for compilation, but only helvety-tasks and helvety-auth integrate it into the UI (EncryptionProvider, EncryptionGate, encryption server actions). helvety.com, helvety-pdf, and helvety-store do **not** use E2EE.

- `lib/crypto/encoding.ts`
- `lib/crypto/encryption.ts`
- `lib/crypto/encryption-context.tsx`
- `lib/crypto/index.ts` – helvety-tasks: not synced; keeps its own file that re-exports task-encryption.ts functions
- `lib/crypto/key-storage.ts`
- `lib/crypto/passkey.ts`
- `lib/crypto/prf-key-derivation.ts`
- `lib/crypto/types.ts`
- `lib/crypto/task-encryption.ts` – helvety-tasks only; app-specific encryption helpers for Units, Spaces, Items, etc.

### Auth Utilities (must be identical across repos that use them)

- `lib/auth-errors.ts`
- `lib/auth-logger.ts`
- `lib/auth-redirect.ts`
- `lib/auth-guard.ts` – helvety-auth: not synced (redirects to local `/login`). Other apps: synced (redirects to auth service via `getLoginUrl()`).
- `lib/redirect-validation.ts`
- `lib/rate-limit.ts`
- `lib/csrf.ts`

### Environment & Session (must be identical across repos that use them)

- `lib/env-validation.ts` – helvety-store: not synced; keeps its own file with Stripe key validation. Other apps: synced.
- `lib/session-config.ts`

### Supabase Clients (must be identical)

- `lib/supabase/client.ts`
- `lib/supabase/server.ts`
- `lib/supabase/admin.ts`
- `lib/supabase/client-factory.ts`

### Types (must be identical)

- `lib/types/entities.ts` – shared entity types (UserAuthCredential, UserPasskeyParams, UserProfile, ActionResponse)

### Hooks (must be identical across repos that use them)

- `hooks/use-auth-session.ts` – helvety-auth: not synced (no redirect, idle timeout disabled). Other apps: synced.

### App Pages (must be identical)

- `app/error.tsx` – global error boundary
- `app/not-found.tsx` – global 404 page

### Components (must be identical)

- `components/theme-provider.tsx`
- `components/theme-switcher.tsx`
- `components/app-switcher.tsx`

### Infrastructure (must be identical)

- `proxy.ts` (Next.js 16 proxy: session refresh and cookie domain) – helvety-store: includes CSRF token generation. Other apps may or may not include it depending on whether they have API routes.
- `scripts/generate-version.js`
- `.cursor/rules/*` – coding standards and patterns (all .mdc files)

## App-Specific Code

Put app-specific utilities in appropriately named files:

- **helvety-pdf**: `lib/pdf-*.ts`, `lib/file-*.ts`, `lib/memory-*.ts`
- **helvety-store**: `lib/stripe/*.ts`, `lib/license/*.ts`, `lib/packages/*.ts`
- **helvety-auth**: `lib/auth-utils.ts` (auth-specific, not shared)
- **helvety-tasks**: `app/actions/stage-actions.ts`, `app/actions/task-actions.ts` (task CRUD, not shared)

## Future: Shared Package (@helvety/shared)

When the number of shared files grows further or diverges become costly, extract shared code into an internal npm package `@helvety/shared`. This would include:
- All crypto utilities
- Auth guard, auth redirect, auth errors, auth logger
- CSRF, rate limiting, redirect validation
- Supabase client factories
- Logger, utils, constants
- Sentry configuration

This eliminates manual sync and ensures security fixes propagate instantly across all repos.

## When Adding New Shared Code

1. Add to one repo first
2. Verify the changes work correctly
3. Copy to all other repos
4. Commit changes to all repos together (or sequentially)

## Sync Script

Run `node scripts/sync-shared.js` from helvety.com to copy all shared files to the other repos.

- `--dry-run` – Preview changes without copying files
- `--check` – Compare only; exits with code 1 if any files have drifted (useful for CI or pre-deploy verification)

The script validates source files, reports diffs, and provides a summary.
